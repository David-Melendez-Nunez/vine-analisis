<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vine Analytics & Tax Pro 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        .drag-active { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
        .tab-inactive:hover { color: #334155; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            .print-break { page-break-before: always; }
            /* Forzar visualización de resultados en impresión */
            #resFinalCard { border: 1px solid #000 !important; color: #000 !important; }
            .bg-slate-900 { background-color: #fff !important; color: #000 !important; border: 1px solid #000; }
            .text-white { color: #000 !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-20">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-lg md:text-xl font-bold flex items-center gap-2">
                <i class="fa-brands fa-amazon text-yellow-500"></i> Vine Analytics <span class="text-xs bg-indigo-600 px-2 py-0.5 rounded ml-2 shadow-inner">v3.2</span>
            </h1>
            <button onclick="window.print()" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded transition flex items-center gap-2">
                <i class="fa-solid fa-print"></i> <span class="hidden md:inline">Imprimir PDF</span>
            </button>
        </div>
    </nav>

    <!-- Navegación -->
    <div class="bg-white border-b border-slate-200 sticky top-[60px] z-40 shadow-sm no-print">
        <div class="container mx-auto px-4">
            <div class="flex space-x-6 overflow-x-auto no-scrollbar">
                <button onclick="switchMainTab('dashboard')" id="tab-dashboard" class="py-4 text-sm font-medium tab-active transition whitespace-nowrap">
                    <i class="fa-solid fa-chart-pie mr-2"></i>Dashboard & DAC7
                </button>
                <button onclick="switchMainTab('tax')" id="tab-tax" class="py-4 text-sm font-medium tab-inactive transition whitespace-nowrap">
                    <i class="fa-solid fa-calculator mr-2"></i>Simulador Hacienda
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- VISTA 1: DASHBOARD -->
        <div id="view-dashboard" class="animate-slide-in">
            <!-- Monitor DAC7 -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 relative overflow-hidden">
                <div class="flex justify-between items-end mb-2 relative z-10">
                    <div>
                        <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Monitor DAC7 (Europa)</h2>
                        <p class="text-xs text-slate-400">Límites: 2.000€ o 30 Ventas/Items</p>
                    </div>
                    <div id="dac7Status" class="text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700">Zona Segura</div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 relative z-10">
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-slate-600">Importe Acumulado</span>
                            <span class="text-slate-500"><span id="dacMoneyVal">0</span> / 2.000 €</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                            <div id="dacMoneyBar" class="bg-blue-500 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-slate-600">Items Reportables</span>
                            <span class="text-slate-500"><span id="dacItemsVal">0</span> / 30 Items</span>
                        </div>
                        <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden">
                            <div id="dacItemsBar" class="bg-blue-500 h-full rounded-full transition-all duration-1000" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Izquierda: Carga -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 no-print">
                        <h2 class="text-base font-semibold mb-4 text-slate-700">Cargar Datos</h2>
                        <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center transition-all cursor-pointer hover:border-blue-400 hover:bg-slate-50 relative group">
                            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                            <div class="pointer-events-none group-hover:scale-105 transition-transform duration-200">
                                <i class="fa-solid fa-file-excel text-3xl text-green-600 mb-2"></i>
                                <p class="text-sm font-medium text-slate-700">Arrastra tu Excel aquí</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-between text-sm">
                             <div><p class="text-xs text-slate-400">Total Fiscal</p><p id="dashTotalAmount" class="font-bold text-slate-800">0,00 €</p></div>
                             <div><p class="text-xs text-slate-400">Items Gratuitos</p><p id="dashTotalZero" class="font-bold text-green-600">0</p></div>
                        </div>
                    </div>
                    <!-- Top Items -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-base font-semibold mb-4 text-slate-700 flex items-center gap-2"><i class="fa-solid fa-crown text-yellow-500"></i> Top 5 "Whales"</h2>
                        <div id="topItemsContainer" class="space-y-3"><p class="text-xs text-slate-400 italic text-center py-4">Carga datos...</p></div>
                    </div>
                </div>

                <!-- Derecha: Gráficos -->
                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-slate-100 p-1 rounded-lg inline-flex w-full sm:w-auto no-print">
                        <button onclick="switchChartMode('fiscal')" id="btn-chart-fiscal" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-xs font-semibold shadow-sm bg-white text-slate-800 transition">Fiscal (€)</button>
                        <button onclick="switchChartMode('zero')" id="btn-chart-zero" class="flex-1 sm:flex-none px-4 py-2 rounded-md text-xs font-semibold text-slate-500 hover:text-slate-700 transition">Gratis (0€)</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-80 relative">
                        <canvas id="expenseChart"></canvas>
                        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-10"><p class="text-sm text-slate-400">Esperando archivo...</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-72 relative">
                        <h3 class="text-xs font-bold text-slate-400 uppercase mb-2">Evolución Mensual (Gasto)</h3>
                        <canvas id="monthlyChart"></canvas>
                    </div>
                    <div id="cardsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- VISTA 2: SIMULADOR IRPF -->
        <div id="view-tax" class="hidden animate-slide-in">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Formulario -->
                <div class="lg:col-span-1 space-y-6 no-print">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 border-t-4 border-t-blue-500">
                        <h2 class="text-lg font-bold text-slate-800 mb-1">Calculadora IRPF</h2>
                        <p class="text-xs text-slate-400 mb-4">Introduce tus datos para estimar el impacto.</p>

                        <form id="taxForm" oninput="calculateTaxAndSave()" class="space-y-4">
                            <!-- Salario -->
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Salario Bruto Anual</label>
                                <div class="relative">
                                    <input type="number" id="taxSalary" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-slate-50" placeholder="Ej: 24000">
                                    <span class="absolute right-3 top-2 text-slate-400 text-xs">€</span>
                                </div>
                            </div>

                            <!-- RETENCIÓN (NUEVO) -->
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Retención Nómina (%)</label>
                                <div class="relative">
                                    <input type="number" id="taxRetention" step="0.1" class="w-full px-3 py-2 border border-blue-200 rounded-lg text-sm bg-blue-50 focus:ring-2 focus:ring-blue-400 outline-none" placeholder="Ej: 12.5">
                                    <span class="absolute right-3 top-2 text-blue-400 text-xs font-bold">%</span>
                                </div>
                                <p class="text-[10px] text-slate-400 mt-1">Mira tu nómina o pon una estimación.</p>
                            </div>

                            <!-- Vine -->
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 uppercase mb-1 flex justify-between">
                                    <span>Valor Vine (Etv)</span>
                                    <span class="text-[10px] bg-green-100 text-green-700 px-1.5 rounded hidden" id="vineAutoBadge">Auto</span>
                                </label>
                                <div class="relative">
                                    <input type="number" id="taxVine" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm bg-yellow-50" placeholder="0.00">
                                    <span class="absolute right-3 top-2 text-slate-400 text-xs">€</span>
                                </div>
                            </div>
                            <hr class="border-slate-100">
                            
                            <!-- Situación Personal -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-600 mb-1">Edad</label>
                                    <input type="number" id="taxAge" value="35" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-slate-600 mb-1">Hijos</label>
                                    <select id="taxChildren" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                        <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4+</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-600 mb-1">Discapacidad</label>
                                <select id="taxDisability" class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm">
                                    <option value="0">Ninguna</option><option value="33">33% - 65%</option><option value="65">+65%</option>
                                </select>
                            </div>
                        </form>
                    </div>

                    <!-- EXPLICACIÓN MINIMO -->
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Tu Mínimo Exento</h4>
                        <div class="space-y-1 text-xs text-blue-900">
                            <div class="flex justify-between"><span>Base Personal:</span> <span class="font-mono font-bold">5.550 €</span></div>
                            <div class="flex justify-between text-blue-600"><span>+ Por Edad:</span> <span class="font-mono" id="dispMinAge">0 €</span></div>
                            <div class="flex justify-between text-blue-600"><span>+ Por Hijos:</span> <span class="font-mono" id="dispMinKids">0 €</span></div>
                            <div class="flex justify-between text-blue-600"><span>+ Discapacidad:</span> <span class="font-mono" id="dispMinDis">0 €</span></div>
                            <div class="border-t border-blue-200 mt-1 pt-1 flex justify-between font-bold"><span>TOTAL:</span> <span class="font-mono text-base" id="dispMinTotal">5.550 €</span></div>
                        </div>
                    </div>
                </div>

                <!-- Resultados -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <!-- 1. IMPACTO VINE (Coste Marginal) -->
                    <div class="bg-slate-900 text-white p-6 rounded-2xl shadow-xl relative overflow-hidden print:bg-white print:text-black print:border print:border-black">
                        <div class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 bg-indigo-500 rounded-full opacity-20 blur-2xl print:hidden"></div>
                        <h3 class="text-sm font-medium text-slate-400 uppercase tracking-wider mb-2 print:text-black">Coste "Extra" por Vine</h3>
                        <div class="flex items-baseline gap-2">
                            <span id="resDifference" class="text-4xl md:text-5xl font-bold text-white print:text-black">0 €</span>
                            <span class="text-sm text-slate-400 print:text-black">impuestos generados</span>
                        </div>
                        <div class="mt-4 text-xs text-slate-400 print:text-black">
                            Esto es lo que Vine añade a tu factura teórica. <br>
                            Sin Vine pagarías: <span id="resTaxNoVineMini" class="font-bold text-white print:text-black">0 €</span>. 
                            Con Vine pagas: <span id="resTaxWithVineMini" class="font-bold text-white print:text-black">0 €</span>.
                        </div>
                    </div>

                    <!-- 2. RESULTADO DECLARACIÓN (NUEVO) -->
                    <div id="resFinalCard" class="bg-white p-6 rounded-2xl shadow-lg border-2 border-slate-100 relative overflow-hidden transition-colors duration-500">
                        <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">Resultado Estimado Renta</h3>
                        <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div>
                                <div id="resFinalAmount" class="text-4xl md:text-5xl font-bold text-slate-300">--- €</div>
                                <div id="resFinalText" class="text-sm font-bold uppercase mt-1 text-slate-400">FALTAN DATOS</div>
                            </div>
                            <div class="text-right text-xs text-slate-500 space-y-1">
                                <div>Impuesto Total: <span id="resTotalTaxCalc" class="font-mono font-bold">0 €</span></div>
                                <div>- Ya Retenido (Nómina): <span id="resAlreadyPaid" class="font-mono font-bold text-blue-600">0 €</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Desglose -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">Detalles Simulación</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-slate-50 py-2">
                                <span class="text-slate-600">Base Imponible Total</span>
                                <span id="resBaseTotal" class="font-mono font-bold text-slate-800">0 €</span>
                            </div>
                            <div class="flex justify-between border-b border-slate-50 py-2">
                                <span class="text-slate-600">Tipo Medio Efectivo</span>
                                <span id="resRate" class="font-mono font-bold text-yellow-600">0%</span>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-4 italic">* Estimación basada en tablas estatales 2024. No es vinculante.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // --- CONSTANTS & VARS ---
        const categories = {
            'Tecnología': ['cargador', 'usb', 'cable', 'mouse', 'teclado', 'auriculares', 'altavoz', 'pantalla', 'móvil', 'tablet', 'ordenador', 'disco', 'memoria', 'wifi', 'bluetooth', 'smartwatch', 'drone'],
            'Hogar': ['luz', 'lámpara', 'led', 'bombilla', 'estantería', 'mueble', 'silla', 'mesa', 'alfombra', 'cortina', 'jardín', 'herramienta', 'taladro', 'aspiradora', 'limpieza', 'baño', 'grifo', 'ducha', 'colchón'],
            'Cocina': ['sartén', 'olla', 'cuchillo', 'plato', 'vaso', 'taza', 'botella', 'batidora', 'cafetera', 'molde', 'air fryer', 'freidora', 'tupper', 'vino'],
            'Ropa': ['camiseta', 'pantalón', 'vestido', 'zapato', 'zapatilla', 'bota', 'calcetin', 'ropa', 'bolso', 'mochila', 'cartera', 'cinturón', 'gafas'],
            'Belleza': ['crema', 'champu', 'jabón', 'maquillaje', 'pintalabios', 'masajeador', 'afeitadora', 'secador', 'pelo', 'uña', 'perfume', 'suplemento'],
            'Juguetes': ['juguete', 'muñeca', 'lego', 'puzzle', 'bebé', 'niño', 'niña', 'juego'],
            'Mascotas': ['perro', 'gato', 'mascota', 'correa', 'collar', 'acuario', 'pez', 'arena'],
            'Deportes': ['pesa', 'mancuerna', 'yoga', 'bici', 'patinete', 'balón', 'fútbol', 'tenis', 'gimnasio', 'camping']
        };
        const categoryColors = {'Tecnología':'#3b82f6','Hogar':'#10b981','Cocina':'#f59e0b','Ropa':'#8b5cf6','Belleza':'#ec4899','Juguetes':'#06b6d4','Mascotas':'#a855f7','Deportes':'#ef4444','Otros':'#64748b'};

        let fiscalData = { totals: {}, grandTotal: 0, itemsList: [], count: 0 };
        let zeroData = { totals: {}, grandTotal: 0 };
        let monthlyData = Array(12).fill(0);
        let currentChartMode = 'fiscal';
        let myChart = null;
        let monthlyChartInstance = null;

        window.onload = function() { loadSavedTaxData(); };

        function loadSavedTaxData() {
            const saved = localStorage.getItem('vineTaxData_v3');
            if(saved) {
                const data = JSON.parse(saved);
                if(data.salary) document.getElementById('taxSalary').value = data.salary;
                if(data.retention) document.getElementById('taxRetention').value = data.retention;
                if(data.age) document.getElementById('taxAge').value = data.age;
                if(data.children) document.getElementById('taxChildren').value = data.children;
                if(data.disability) document.getElementById('taxDisability').value = data.disability;
                calculateTaxAndSave();
            }
        }

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                processData(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(rows) {
            fiscalData = { totals: {}, grandTotal: 0, itemsList: [], count: 0 };
            zeroData = { totals: {}, grandTotal: 0 };
            monthlyData = Array(12).fill(0);

            let hIdx = rows.findIndex(r => r.some(c => c && c.toString().includes("Consideration Amount")));
            if(hIdx === -1) return alert("Formato inválido");
            
            let cName = rows[hIdx].findIndex(c => c.toString().includes("Product Name"));
            let cPrice = rows[hIdx].findIndex(c => c.toString().includes("Consideration Amount"));
            let cDate = rows[hIdx].findIndex(c => c.toString().includes("Order Date"));

            for(let i = hIdx+1; i < rows.length; i++) {
                let row = rows[i];
                if(!row[cName]) continue;
                let pRaw = row[cPrice];
                if(pRaw === undefined) continue;
                let price = typeof pRaw === 'number' ? pRaw : parseFloat(pRaw.toString().replace(/[€,]/g, '.'));
                if(typeof pRaw === 'string' && pRaw.includes(',') && !pRaw.includes('.')) price = parseFloat(pRaw.replace('€','').replace(',','.'));
                if(isNaN(price)) continue;

                let name = row[cName].toString();
                let cat = 'Otros';
                for(let k in categories) if(categories[k].some(x => name.toLowerCase().includes(x))) { cat = k; break; }

                if(row[cDate]) {
                    let m = -1;
                    if(typeof row[cDate] === 'number') { 
                        let d = XLSX.SSF.parse_date_code(row[cDate]);
                        m = d.m - 1;
                    } else {
                        let dStr = row[cDate];
                        let parts = dStr.split(/[\/\-]/);
                        if(parts.length === 3) m = parseInt(parts[0]) - 1; 
                        if(m > 11) m = parseInt(parts[1]) - 1;
                    }
                    if(m >= 0 && m <= 11 && price !== 0) monthlyData[m] += price;
                }

                if(price === 0) {
                    zeroData.totals[cat] = (zeroData.totals[cat] || 0) + 1;
                    zeroData.grandTotal++;
                } else {
                    fiscalData.totals[cat] = (fiscalData.totals[cat] || 0) + price;
                    fiscalData.grandTotal += price;
                    fiscalData.itemsList.push({name: name, price: price});
                    if(price > 0) fiscalData.count++; else fiscalData.count--;
                }
            }

            updateDashboardUI();
            updateDAC7();
            updateTopItems();
            updateMonthlyChart();
            
            document.getElementById('taxVine').value = fiscalData.grandTotal.toFixed(2);
            document.getElementById('vineAutoBadge').classList.remove('hidden');
            calculateTaxAndSave();
        }

        // ... (Dashboard UI functions same as before) ...
        function updateDashboardUI() {
            document.getElementById('dashTotalAmount').innerText = fiscalData.grandTotal.toLocaleString('es-ES', {style:'currency', currency:'EUR'});
            document.getElementById('dashTotalZero').innerText = zeroData.grandTotal;
            document.getElementById('emptyState').style.display = 'none';
            const dataObj = currentChartMode === 'fiscal' ? fiscalData.totals : zeroData.totals;
            const ctx = document.getElementById('expenseChart').getContext('2d');
            const labels = Object.keys(dataObj).filter(k => dataObj[k] > 0);
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels, datasets: [{ data: labels.map(k=>dataObj[k]), backgroundColor: labels.map(k=>categoryColors[k]), borderWidth: 2, borderColor:'#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } } } });
            
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            labels.sort((a,b) => dataObj[b] - dataObj[a]).slice(0, 4).forEach(cat => {
                let val = dataObj[cat];
                let fmt = currentChartMode === 'fiscal' ? val.toLocaleString('es-ES',{style:'currency',currency:'EUR', maximumFractionDigits:0}) : val;
                container.innerHTML += `<div class="bg-white p-2 rounded border text-center shadow-sm"><div class="w-2 h-2 rounded-full mx-auto mb-1" style="background-color:${categoryColors[cat]}"></div><p class="text-[10px] uppercase font-bold text-slate-500 truncate">${cat}</p><p class="text-sm font-bold text-slate-800">${fmt}</p></div>`;
            });
        }
        
        function updateDAC7() {
            const money = fiscalData.grandTotal; const items = fiscalData.count;
            document.getElementById('dacMoneyVal').innerText = money.toLocaleString('es-ES', {maximumFractionDigits:0});
            document.getElementById('dacItemsVal').innerText = items;
            const pm = Math.min((money/2000)*100, 100); const pi = Math.min((items/30)*100, 100);
            document.getElementById('dacMoneyBar').style.width = pm + '%'; document.getElementById('dacItemsBar').style.width = pi + '%';
            const st = document.getElementById('dac7Status');
            if(pm >= 100 || pi >= 100) { st.innerText = "LÍMITE ALCANZADO"; st.className = "text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-700 animate-pulse"; document.getElementById('dacMoneyBar').classList.add('bg-red-500'); document.getElementById('dacItemsBar').classList.add('bg-red-500'); }
            else if(pm > 80 || pi > 80) { st.innerText = "PRECAUCIÓN"; st.className = "text-xs font-bold px-2 py-1 rounded bg-yellow-100 text-yellow-700"; document.getElementById('dacMoneyBar').classList.add('bg-yellow-500'); document.getElementById('dacItemsBar').classList.add('bg-yellow-500'); }
            else { st.innerText = "ZONA SEGURA"; st.className = "text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700"; }
        }

        function updateTopItems() {
            const list = fiscalData.itemsList.sort((a,b) => b.price - a.price).slice(0, 5);
            document.getElementById('topItemsContainer').innerHTML = list.map((x,i) => `<div class="flex justify-between items-center text-sm border-b border-slate-50 last:border-0 pb-2"><div class="flex items-center gap-2 overflow-hidden"><span class="text-xs font-bold text-slate-300">#${i+1}</span><span class="truncate text-slate-600" title="${x.name}">${x.name.substring(0,25)}...</span></div><span class="font-mono font-medium text-slate-800">${x.price.toFixed(0)}€</span></div>`).join('');
        }
        
        function updateMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            if(monthlyChartInstance) monthlyChartInstance.destroy();
            monthlyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'], datasets: [{ label: 'Gasto (€)', data: monthlyData, backgroundColor: '#94a3b8', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x:{grid:{display:false}}, y:{beginAtZero:true, grid:{display:false}} }, plugins: { legend: { display: false } } } });
        }


        // --- TAX CALCULATION V3.2 ---
        function calculateTaxAndSave() {
            let s = parseFloat(document.getElementById('taxSalary').value) || 0;
            let retPercent = parseFloat(document.getElementById('taxRetention').value) || 0; // NUEVO
            let v = parseFloat(document.getElementById('taxVine').value) || 0;
            let a = parseInt(document.getElementById('taxAge').value) || 35;
            let c = parseInt(document.getElementById('taxChildren').value) || 0;
            let d = parseInt(document.getElementById('taxDisability').value) || 0;

            localStorage.setItem('vineTaxData_v3', JSON.stringify({ salary: s, retention: retPercent, age: a, children: c, disability: d }));

            // 1. Minimos
            let minBase = 5550;
            let minAge = (a > 65 ? 1150 : 0) + (a > 75 ? 1400 : 0);
            let minC = 0; if(c >= 1) minC += 2400; if(c >= 2) minC += 2700; if(c >= 3) minC += 4000; if(c >= 4) minC += 4500;
            let minD = (d >= 65 ? 9000 : (d >= 33 ? 3000 : 0));
            let totalMin = minBase + minAge + minC + minD;

            // UI Minimos
            document.getElementById('dispMinAge').innerText = minAge > 0 ? `+${minAge} €` : "0 €";
            document.getElementById('dispMinKids').innerText = minC > 0 ? `+${minC} €` : "0 €";
            document.getElementById('dispMinDis').innerText = minD > 0 ? `+${minD} €` : "0 €";
            document.getElementById('dispMinTotal').innerText = totalMin.toLocaleString('es-ES', {style:'currency', currency:'EUR'});

            // 2. Calculo Impuesto Teórico
            const getTax = (base, min) => {
                const rates = [[12450,0.19],[20200,0.24],[35200,0.30],[60000,0.37],[300000,0.45],[Infinity,0.47]];
                const calc = (amount) => {
                    let tax = 0, floor = 0;
                    for(let r of rates) {
                        if(amount > floor) {
                            tax += (Math.min(amount, r[0]) - floor) * r[1];
                            floor = r[0];
                        }
                    }
                    return tax;
                };
                return Math.max(0, calc(base) - calc(min));
            };

            let expenses = 2000 + (s * 0.0635);
            let netBase = Math.max(0, s - expenses);
            
            let taxNo = getTax(netBase, totalMin);
            let taxYes = getTax(netBase + v, totalMin); // Impuesto Total Teórico
            
            let diff = taxYes - taxNo; // Coste Vine
            let rate = (netBase + v) > 0 ? (taxYes / (s + v)) * 100 : 0;

            // 3. Calculo Resultado Final (Con Retenciones)
            let alreadyPaid = s * (retPercent / 100);
            let finalResult = taxYes - alreadyPaid; // Positivo = Pagar, Negativo = Devolver

            // UI Updates 1 (Impacto Vine)
            document.getElementById('resDifference').innerText = diff.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
            document.getElementById('resTaxNoVineMini').innerText = taxNo.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
            document.getElementById('resTaxWithVineMini').innerText = taxYes.toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
            
            // UI Updates 2 (Resultado Final)
            const finalCard = document.getElementById('resFinalCard');
            const finalAmt = document.getElementById('resFinalAmount');
            const finalText = document.getElementById('resFinalText');

            if(s > 0) {
                finalAmt.innerText = Math.abs(finalResult).toLocaleString('es-ES', {style:'currency', currency:'EUR', maximumFractionDigits:0});
                if(finalResult > 0) {
                    // A PAGAR
                    finalCard.className = "bg-white p-6 rounded-2xl shadow-lg border-2 border-red-100 relative overflow-hidden transition-colors duration-500";
                    finalAmt.className = "text-4xl md:text-5xl font-bold text-red-500";
                    finalText.innerText = "A PAGAR (SALE POSITIVA)";
                    finalText.className = "text-sm font-bold uppercase mt-1 text-red-400";
                } else {
                    // A DEVOLVER
                    finalCard.className = "bg-white p-6 rounded-2xl shadow-lg border-2 border-green-100 relative overflow-hidden transition-colors duration-500";
                    finalAmt.className = "text-4xl md:text-5xl font-bold text-green-500";
                    finalText.innerText = "A DEVOLVER (SALE NEGATIVA)";
                    finalText.className = "text-sm font-bold uppercase mt-1 text-green-400";
                }
            } else {
                finalAmt.innerText = "--- €";
                finalText.innerText = "FALTAN DATOS";
                finalCard.className = "bg-white p-6 rounded-2xl shadow-lg border-2 border-slate-100 relative overflow-hidden";
            }

            document.getElementById('resTotalTaxCalc').innerText = taxYes.toLocaleString('es-ES', {style:'currency', currency:'EUR'});
            document.getElementById('resAlreadyPaid').innerText = "- " + alreadyPaid.toLocaleString('es-ES', {style:'currency', currency:'EUR'});

            // UI General
            document.getElementById('resRate').innerText = rate.toFixed(1) + '%';
            document.getElementById('resBar').style.width = Math.min(rate * 1.5, 100) + '%';
            document.getElementById('resBaseTotal').innerText = (s + v).toLocaleString('es-ES', {style:'currency', currency:'EUR'});
        }

        function switchMainTab(t) {
            document.getElementById('view-dashboard').classList.add('hidden'); document.getElementById('view-tax').classList.add('hidden');
            document.getElementById('view-'+t).classList.remove('hidden');
            document.getElementById('tab-dashboard').className = t==='dashboard'?'py-4 text-sm font-medium tab-active transition whitespace-nowrap':'py-4 text-sm font-medium tab-inactive transition whitespace-nowrap';
            document.getElementById('tab-tax').className = t==='tax'?'py-4 text-sm font-medium tab-active transition whitespace-nowrap':'py-4 text-sm font-medium tab-inactive transition whitespace-nowrap';
        }
        function switchChartMode(m) {
            currentChartMode = m;
            document.getElementById('btn-chart-fiscal').className = m === 'fiscal' ? "px-4 py-2 rounded-md text-xs font-semibold shadow-sm bg-white text-slate-800 transition" : "px-4 py-2 rounded-md text-xs font-semibold text-slate-500 hover:text-slate-700 transition";
            document.getElementById('btn-chart-zero').className = m === 'zero' ? "px-4 py-2 rounded-md text-xs font-semibold shadow-sm bg-white text-green-700 transition" : "px-4 py-2 rounded-md text-xs font-semibold text-slate-500 hover:text-slate-700 transition";
            updateDashboardUI();
        }
    </script>
</body>
</html>